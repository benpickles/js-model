var Model=function(j,e){var g=function(a){this._name=j;this.attributes=a||{};this.changes={};this.collection=f;this.errors=[];this.trigger("initialize")},f;if(e&&e.collection){f=e.collection;delete e.collection}else f=Model.Collection();g=$.extend(g,f);g.prototype=$.extend({attr:function(a,b){if(arguments.length==2){if(_.isEqual(this.attributes[a],b))delete this.changes[a];else this.changes[a]=b;return this}else if(typeof a=="object"){for(var c in a)this.attr(c,a[c]);return this}else return a in this.changes?
this.changes[a]:this.attributes[a]},callPersistMethod:function(a,b,c){var d=this,h=function(){if(d.collection)if(a=="create")d.collection.add(d);else a=="destroy"&&d.collection.remove(d.id())};if(this.persistence)this.persistence[a](this,function(){h();var i;if(b)i=b.apply(d,arguments);d.trigger(a);return i},c);else{h();this.trigger(a)}},destroy:function(a,b){this.callPersistMethod("destroy",a,b);return this},id:function(){return this.attributes.id||null},newRecord:function(){return this.id()==null},
reset:function(){this.changes={};return this},save:function(a,b){if(!this.valid())return false;this.update(this.changes).reset();this.callPersistMethod(this.newRecord()?"create":"update",a,b);return true},toParam:function(){var a={};for(var b in this.attributes){var c=this.attributes[b];if(b!="id"&&c!=null)a[this._name+"["+b+"]"]=c}return a},trigger:function(a){$(document).trigger([a,this._name].join("."),[this]);return this},update:function(a){$.extend(this.attributes,a);return this},valid:function(){this.errors=
[];this.validate();return this.errors.length==0},validate:function(){return this}},e);return g};
