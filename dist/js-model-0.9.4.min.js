/*  js-model JavaScript library, version 0.9.4
 *  (c) 2010 Ben Pickles
 *
 *  Released under MIT license.
 */
var Model=function(a,b,c){b=b||{};c=c||{};var d=function(e){this.attributes=jQuery.extend({},e);this.changes={};this.errors=new Model.Errors(this);this.uid=[a,Model.UID.generate()].join("-");jQuery.isFunction(this.initialize)&&this.initialize()},i=b.persistence;delete b.persistence;jQuery.extend(d,Model.Callbacks,Model.ClassMethods,b,{_name:a,collection:[],chain:function(e){return jQuery.extend({},this,{collection:e})}});if(i)d.persistence=i(d);jQuery.extend(d.prototype,Model.Callbacks,Model.InstanceMethods,
c);return d};Model.Callbacks={bind:function(a,b){this.callbacks=this.callbacks||{};this.callbacks[a]=this.callbacks[a]||[];this.callbacks[a].push(b);return this},trigger:function(a,b){this.callbacks=this.callbacks||{};if(a=this.callbacks[a])for(var c=0;c<a.length;c++)a[c].apply(this,b||[]);return this},unbind:function(a,b){this.callbacks=this.callbacks||{};if(b)for(var c=this.callbacks[a]||[],d=0;d<c.length;d++)c[d]===b&&this.callbacks[a].splice(d,1);else delete this.callbacks[a];return this}};
Model.ClassMethods={unique_key:"id",add:function(){for(var a=[],b=0;b<arguments.length;b++){var c=arguments[b],d=c.id();if(jQuery.inArray(c,this.collection)===-1&&!(d&&this.find(d))){this.collection.push(c);a.push(c)}}a.length>0&&this.trigger("add",a);return this},all:function(){return this.collection.slice()},count:function(){return this.collection.length},detect:function(a){for(var b=this.all(),c,d=0,i=b.length;d<i;d++){c=b[d];if(a.call(c,d))return c}},each:function(a){for(var b=this.all(),c=0,
d=b.length;c<d;c++)a.call(b[c],c);return this},find:function(a){return this.detect(function(){return this.id()==a})},first:function(){return this.all()[0]},load:function(a){if(this.persistence){var b=this;this.persistence.read(function(c){for(var d=0,i=c.length;d<i;d++)b.add(c[d]);a&&a.call(b,c)})}return this},last:function(){var a=this.all();return a[a.length-1]},map:function(a){for(var b=this.all(),c=[],d=0,i=b.length;d<i;d++)c.push(a.call(b[d],b[d],d));return c},pluck:function(a){for(var b=this.all(),
c=[],d=0,i=b.length;d<i;d++)c.push(b[d].attr(a));return c},remove:function(a){for(var b,c=0,d=this.collection.length;c<d;c++)if(this.collection[c]===a){b=c;break}if(b!=undefined){this.collection.splice(b,1);this.trigger("remove",[a]);return true}else return false},reverse:function(){return this.chain(this.all().reverse())},select:function(a){for(var b=this.all(),c=[],d,i=0,e=b.length;i<e;i++){d=b[i];a.call(d,i)&&c.push(d)}return this.chain(c)},sort:function(a){return this.chain(this.all().slice().sort(a))},
sortBy:function(a){var b=jQuery.isFunction(a),c=function(d){return a.call(d)};return this.sort(function(d,i){d=b?c(d):d.attr(a);i=b?c(i):i.attr(a);return d<i?-1:d>i?1:0})}};Model.Errors=function(a){this.errors={};this.model=a};
Model.Errors.prototype={add:function(a,b){this.errors[a]||(this.errors[a]=[]);this.errors[a].push(b);return this},all:function(){return this.errors},clear:function(){this.errors={};return this},each:function(a){for(var b in this.errors)for(var c=0;c<this.errors[b].length;c++)a.call(this,b,this.errors[b][c]);return this},on:function(a){return this.errors[a]||[]},size:function(){var a=0;this.each(function(){a++});return a}};
Model.InstanceMethods={attr:function(a,b){if(arguments.length===0)return jQuery.extend({},this.attributes,this.changes);else if(arguments.length===2){if(this.attributes[a]===b)delete this.changes[a];else this.changes[a]=b;return this}else if(typeof a==="object"){for(var c in a)this.attr(c,a[c]);return this}else return a in this.changes?this.changes[a]:this.attributes[a]},callPersistMethod:function(a,b){var c=this,d=function(){if(a==="create")c.constructor.add(c);else a==="destroy"&&c.constructor.remove(c)},
i=function(e){if(e){c.merge(c.changes).reset();d();c.trigger(a)}var g;if(b)g=b.apply(c,arguments);return g};this.constructor.persistence?this.constructor.persistence[a](this,i):i.call(this,true)},destroy:function(a){this.callPersistMethod("destroy",a);return this},id:function(){return this.attributes[this.constructor.unique_key]},merge:function(a){jQuery.extend(this.attributes,a);return this},newRecord:function(){return this.id()===undefined},reset:function(){this.errors.clear();this.changes={};return this},
save:function(a){if(this.valid())this.callPersistMethod(this.newRecord()?"create":"update",a);else a&&a(false);return this},valid:function(){this.errors.clear();this.validate();return this.errors.size()===0},validate:function(){return this}};
Model.localStorage=function(){if(!window.localStorage)return function(){return{create:function(a,b){b(true)},destroy:function(a,b){b(true)},read:function(a){a([])},update:function(a,b){b(true)}}};return function(a){var b=[a._name,"collection"].join("-"),c=function(){var f=localStorage[b];return f?JSON.parse(f):[]},d=function(f){localStorage.setItem(b,JSON.stringify(f))},i=function(f){var h=c();if(jQuery.inArray(f,h)===-1){h.push(f);d(h)}},e=function(f){var h=c();f=jQuery.inArray(f,h);if(f>-1){h.splice(f,
1);d(h)}},g=function(f){var h=f.uid;f=JSON.stringify(f.attr());localStorage.setItem(h,f);i(h)};return{create:function(f,h){g(f);h(true)},destroy:function(f,h){localStorage.removeItem(f.uid);e(f.uid);h(true)},read:function(f){if(!f)return false;for(var h=a.map(function(){return this.uid}),j=c(),l=[],k,m,n=0,o=j.length;n<o;n++){m=j[n];if(jQuery.inArray(m,h)==-1){k=JSON.parse(localStorage[m]);k=new a(k);k.uid=m;l.push(k)}}f(l)},update:function(f,h){g(f);h(true)}}}};
Model.Log=function(){window.console&&window.console.log.apply(window.console,arguments)};
Model.REST=function(a,b){var c=/:([\w\d]+)/g,d=function(){for(var e=[],g;(g=c.exec(a))!==null;)e.push(g[1]);return e}(),i=jQuery.extend({path:function(e){var g=a;$.each(d,function(f,h){g=g.replace(":"+h,e.attributes[h])});return g},create:function(e,g){return this.xhr("POST",this.create_path(e),e,g)},create_path:function(e){return this.path(e)},destroy:function(e,g){return this.xhr("DELETE",this.destroy_path(e),e,g)},destroy_path:function(e){return this.update_path(e)},params:function(e){var g;if(e){var f=
e.attr();delete f[e.constructor.unique_key];g={};g[e.constructor._name.toLowerCase()]=f}else g=null;if(jQuery.ajaxSettings.data)g=jQuery.extend({},jQuery.ajaxSettings.data,g);return JSON.stringify(g)},read:function(e){var g=this.klass;return this.xhr("GET",this.read_path(),null,function(f,h,j){j=jQuery.makeArray(j);f=[];h=0;for(var l=j.length;h<l;h++)f.push(new g(j[h]));e(f)})},read_path:function(){return a},update:function(e,g){return this.xhr("PUT",this.update_path(e),e,g)},update_path:function(e){return[this.path(e),
e.id()].join("/")},xhr:function(e,g,f,h){var j=this,l=e=="GET"?undefined:this.params(f);return jQuery.ajax({type:e,url:g,contentType:"application/json",dataType:"json",data:l,dataFilter:function(k){return/\S/.test(k)?k:undefined},complete:function(k,m){j.xhrComplete(k,m,f,h)}})},xhrComplete:function(e,g,f,h){var j=Model.REST["handle"+e.status];j&&j.call(this,e,g,f);g=g==="success";j=Model.REST.parseResponseData(e);g&&f&&j&&f.attr(j);h&&h.call(f,g,e,j)}},b);return function(e){i.klass=e;return i}};
Model.RestPersistence=Model.REST;Model.REST.handle422=function(a,b,c){if(a=Model.REST.parseResponseData(a)){c.errors.clear();for(var d in a)for(b=0;b<a[d].length;b++)c.errors.add(d,a[d][b])}};Model.REST.parseResponseData=function(a){try{return/\S/.test(a.responseText)?jQuery.parseJSON(a.responseText):undefined}catch(b){Model.Log(b)}};Model.UID={counter:0,generate:function(){return[(new Date).valueOf(),this.counter++].join("-")},reset:function(){this.counter=0;return this}};Model.VERSION="0.9.4";
